#!/bin/bash

# Colors
RESET="\033[0m"
BLUE="\033[1;34m"
GREEN="\033[1;32m"
RED="\033[1;31m"
YELLOW="\033[1;33m"
CYAN="\033[1;36m"

# Helper Functions
log_GREEN() {
    echo -e "${GREEN}$1${RESET}"
}

log_RED() {
    echo -e "${RED}$1${RESET}"
}

log_BLUE() {
    echo -e "${BLUE}$1${RESET}"
}

log_YELLOW() {
    echo -e "${YELLOW}$1${RESET}"
}

log_CYAN() {
    echo -e "${CYAN}$1${RESET}"
}

# ============================================================
# SmartDNS One-Click Install & Configuration Script
# Please make sure to run this script as root or with sudo
# ============================================================

REMOTE_SCRIPT_URL="https://raw.githubusercontent.com/lthero-big/Smartdns_sniproxy_installer/refs/heads/main/smtdns_install.sh"
REMOTE_STREAM_CONFIG_FILE_URL="https://raw.githubusercontent.com/lthero-big/Smartdns_sniproxy_installer/refs/heads/main/StreamConfig.yaml"
REMOTE_DNSMASQ_SNIPROXY_URL="https://raw.githubusercontent.com/myxuchangbin/dnsmasq_sniproxy_install/master/dnsmasq_sniproxy.sh"
REMOTE_SMARTDNS_URL="https://github.com/pymumu/smartdns/releases/download/Release46/smartdns.1.2024.06.12-2222.x86-linux-all.tar.gz"
REMOTE_RegionRestrictionCheck_URL="https://raw.githubusercontent.com/1-stream/RegionRestrictionCheck/main/check.sh"

# Script information
SCRIPT_VERSION="V_2.7.1"
LAST_UPDATED=$(date +"%Y-%m-%d")
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

STREAM_CONFIG_FILE="$SCRIPT_DIR/StreamConfig.yaml"
SMART_CONFIG_FILE="/etc/smartdns/smartdns.conf"
SNIPROXY_CONFIG="/etc/sniproxy.conf"

# ============================================================
# Check for script updates
# ============================================================
check_script_update() {
    echo -e "${GREEN}Checking for script updates...${RESET}"

    # Set timeout to 10 seconds
    REMOTE_VERSION=$(curl --max-time 10 -fsSL "$REMOTE_SCRIPT_URL" | grep -E "^SCRIPT_VERSION=" | cut -d'"' -f2)

    # Check if remote version fetch failed
    if [ $? -ne 0 ]; then
        echo -e "${YELLOW}Unable to fetch the latest version (timeout or network issue. Please verify DNS configuration, emergency DNS restore may help).${RESET}"
        return
    fi

    if [ "$REMOTE_VERSION" != "$SCRIPT_VERSION" ]; then
        echo -e "${GREEN}New version detected ($REMOTE_VERSION). Current version: $SCRIPT_VERSION${RESET}"
        echo -e "${GREEN}Do you want to update the script? (y/N)${RESET}"
        read update_choice

        if [[ "$update_choice" == "y" || "$update_choice" == "Y" ]]; then
            echo -e "${GREEN}Updating script...${RESET}"
            curl --max-time 10 -fsSL "$REMOTE_SCRIPT_URL" -o "$0"

            if [ $? -eq 0 ]; then
                chmod +x "$0"
                echo -e "${GREEN}Script updated successfully to $REMOTE_VERSION. Please re-run the script.${RESET}"
                exit 0
            else
                echo -e "${RED}Script update failed.${RESET}"
            fi
        fi
    else
        echo -e "${GREEN}Current script is already the latest version: $SCRIPT_VERSION${RESET}"
    fi
}

# ============================================================
# Add domain rules into the table block of /etc/sniproxy.conf
# ============================================================
add_domain_to_sniproxy_table() {
    local domain="$1"

    # Check if configuration file exists
    if [[ ! -f "$SNIPROXY_CONFIG" ]]; then
        echo -e "${RED}[ERROR] sniproxy configuration file not found: $SNIPROXY_CONFIG${RESET}"
        return 1
    fi

    # Check if table block exists
    local table_start=$(grep -n "^table {" "$SNIPROXY_CONFIG" | cut -d: -f1)

    if [[ -z $table_start ]]; then
        echo -e "${RED}[ERROR] table block not found in sniproxy configuration!${RESET}"
        return 1
    fi

    # Check if domain already exists
    if grep -q ".*${domain//./\\.} *" "$SNIPROXY_CONFIG"; then
        echo -e "${YELLOW}Skipping existing domain: $domain${RESET}"
        return
    fi

    # Insert domain after the last entry inside table block
    sed -i "${table_start}a \    .*${domain//./\\.} *" "$SNIPROXY_CONFIG"
    echo -e "${GREEN}Added domain: $domain into table block${RESET}"
}

# ============================================================
# Add streaming platform domains into sniproxy
# ============================================================
add_streaming_to_sniproxy() {
    local platform_name="$1"
    local sub_platform_name="$2"

    # If sub-platform is provided
    if [[ -n "$sub_platform_name" ]]; then
        echo -e "${CYAN}Processing platform: $platform_name -> $sub_platform_name${RESET}"

        local domains=$(yq ".$platform_name.$sub_platform_name[]" "$STREAM_CONFIG_FILE" 2>/dev/null | tr -d '"')

        if [[ -z $domains ]]; then
            echo -e "${YELLOW}No domain configuration found for $platform_name -> $sub_platform_name, skipping...${RESET}"
            return
        fi

        # Loop through domains and add them to table block
        for domain in $domains; do
            add_domain_to_sniproxy_table "$domain"
        done

    # If only primary platform is provided
    elif [[ -n "$platform_name" ]]; then
        echo -e "${CYAN}Processing primary platform: $platform_name${RESET}"

        local sub_platforms=$(yq ".$platform_name | keys" "$STREAM_CONFIG_FILE" 2>/dev/null | jq -r '.[]')

        if [[ -z $sub_platforms ]]; then
            echo -e "${YELLOW}No sub-platforms found for $platform_name, skipping...${RESET}"
            return
        fi

        # Recursively process each sub-platform
        for sub_platform in $sub_platforms; do
            add_streaming_to_sniproxy "$platform_name" "$sub_platform"
        done
    else
        echo -e "${RED}ERROR: No valid platform name specified!${RESET}"
        return 1
    fi
}

# Call update check function
check_script_update


# Check if running as root
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}[Error] Please run this script as root!${RESET}"
  exit 1
fi

# Check required tools
check_tools() {
    for tool in curl jq; do
        if ! command -v $tool &>/dev/null; then
            echo -e "${RED}$tool is not installed, installing...${RESET}"
            sudo apt-get update && sudo apt-get install -y $tool
        fi
    done

    if ! command -v yq &>/dev/null; then
        echo -e "${RED}yq is not installed, trying to install via pip...${RESET}"
        sudo apt install -y python3-pip
        pip3 install yq
        if ! command -v yq &>/dev/null; then
            echo -e "${RED}yq installation failed, please check manually!${RESET}"
            exit 1
        fi
    fi
}

check_tools

# Get current external IP address and region
IP_INFO=$(curl -s http://ipinfo.io/json)
IP_ADDRESS=$(echo $IP_INFO | jq -r '.ip')
REGION=$(echo $IP_INFO | jq -r '.region')


# Check whether SmartDNS is already installed
check_smartdns_installed() {
    if command -v smartdns &>/dev/null; then
        echo -e "${GREEN}[Installed] SmartDNS is already installed!${RESET}"
        return 0
    else
        echo -e "${RED}[Not Installed] SmartDNS not detected.${RESET}"
        return 1
    fi
}

# Install sniproxy
install_sniproxy() {
    wget --no-check-certificate -O dnsmasq_sniproxy.sh $REMOTE_DNSMASQ_SNIPROXY_URL && bash dnsmasq_sniproxy.sh -fs
}

# Install SmartDNS
install_smartdns() {
    echo -e "${BLUE}Installing SmartDNS...${RESET}"
    TEMP_DIR="/tmp/smartdns_install"
    mkdir -p "$TEMP_DIR"
    cd "$TEMP_DIR" || exit 1

    wget $REMOTE_SMARTDNS_URL
    if [ $? -ne 0 ]; then
        echo -e "${RED}[Error] Failed to download SmartDNS installation package, please check your network connection!${RESET}"
        exit 1
    fi
    
    stop_system_dns

    tar zxf smartdns.1.2024.06.12-2222.x86-linux-all.tar.gz
    cd smartdns || exit 1

    chmod +x ./install
    ./install -i
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}SmartDNS installed successfully!${RESET}"
    else
        echo -e "${RED}[Error] SmartDNS installation failed, please check logs!${RESET}"
        exit 1
    fi

    # Clean up installation temporary files
    cd /
    rm -rf "$TEMP_DIR"
}

# View existing upstream DNS
view_upstream_dns() {
    echo -e "${CYAN}Currently configured upstream DNS list:${RESET}"
    grep -E '^server [0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' "$SMART_CONFIG_FILE" || echo -e "${YELLOW}No upstream DNS configured.${RESET}"
}

# Insert server entry into smartdns.conf
insert_server_into_config() {
    local server_line="$1"       # server entry to insert
    local config_file="$2"       # config file path

    # Check if config file exists
    if [[ ! -f "$config_file" ]]; then
        echo -e "${RED}Configuration file does not exist: $config_file${RESET}"
        return 1
    fi

    # Escape special characters in server_line
    local escaped_server_line=$(echo "$server_line" | sed 's/[\/&]/\\&/g; s/ /\\ /g')

    # Find the position of the last server entry
    local insert_position=$(grep -n "^server " "$config_file" | tail -n 1 | cut -d: -f1)
    # If server entry exists, insert after it
    if [[ -n "$insert_position" ]]; then
        sed -i "${insert_position}a ${escaped_server_line}" "$config_file"
    else
        # If no server entry is found, insert at the beginning of the file
        sed -i "1i $server_line" "$config_file"
        echo -e "${YELLOW}No server entry found, new entry inserted at the beginning: $server_line${RESET}"
    fi
}

# Add upstream DNS group
add_upstream_dns_group() {
    # Add custom upstream DNS groups
    while true; do
        echo -e "${BLUE}Do you want to add a custom upstream DNS group? (y/N): ${RESET}"
        read -r add_dns
        if [[ "$add_dns" =~ ^[Yy]$ ]]; then
            echo -e "${BLUE}Please enter the upstream DNS IP address (format: 11.22.33.44):${RESET}"
            read -r dns_ip
            if [[ ! $dns_ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                echo -e "${RED}Invalid IP address, please re-enter!${RESET}"
                return
            fi
            echo -e "${BLUE}Please enter the group name (e.g.: us):${RESET}"
            read -r group_name
            if [[ -z $group_name ]]; then
                echo -e "${RED}Group name cannot be empty, please re-enter!${RESET}"
                return
            fi
            insert_server_into_config "server $dns_ip IP -group $group_name -exclude-default-group" $SMART_CONFIG_FILE
            echo -e "${GREEN}Successfully added upstream DNS: server $dns_ip IP -group $group_name -exclude-default-group${RESET}"
        else
            break
        fi
    done
}

# View existing upstream DNS groups
view_upstream_dns_groups() {
    echo -e "${CYAN}Currently configured upstream DNS groups:${RESET}"
    grep -E '^server [0-9]+\.[0-9]+\.[0-9]+\.[0-9]+ IP ' "$SMART_CONFIG_FILE" | awk '{print $2, $5}' || echo -e "${YELLOW}No upstream DNS groups configured.${RESET}"
}

# Configure SmartDNS
configure_smartdns() {
    echo -e "${BLUE}Configuring SmartDNS...${RESET}"

    # Default configuration file content
    DEFAULT_CONFIG="bind [::]:53

dualstack-ip-selection no
speed-check-mode none
serve-expired-prefetch-time 21600
prefetch-domain yes
cache-size 32768
cache-persist yes
cache-file /etc/smartdns/cache
prefetch-domain yes
serve-expired yes
serve-expired-ttl 259200
serve-expired-reply-ttl 3
prefetch-domain yes
serve-expired-prefetch-time 21600
cache-checkpoint-time 86400

# Default upstream DNS
server 8.8.8.8
server 8.8.4.4"

    # Write default configuration file
    echo "$DEFAULT_CONFIG" > "$SMART_CONFIG_FILE"
    echo -e "${GREEN}Default configuration file has been generated: $SMART_CONFIG_FILE${RESET}"

    add_upstream_dns_group

    echo -e "${GREEN}SmartDNS configuration completed!${RESET}"
}

# Detect and release services occupying port 53
release_port_53() {
    echo -e "${BLUE}Checking port 53 usage...${RESET}"

    if lsof -i :53 | grep -q LISTEN; then
        echo -e "\033[31mPort 53 is occupied by the following processes:${RESET}"
        lsof -i :53

        # Detect systemd-resolved
        if systemctl is-active --quiet systemd-resolved; then
            echo -e "\033[33msystemd-resolved is running and occupying port 53.${RESET}"
            echo -e "\033[33mAttempting to stop systemd-resolved service...${RESET}"
            systemctl stop systemd-resolved
            systemctl disable systemd-resolved
            echo -e "${GREEN}[Success] systemd-resolved service has been stopped and disabled.${RESET}"
        fi

        # Stop other occupying processes
        lsof -i :53 | awk 'NR>1 {print $2}' | xargs -r kill -9
        echo -e "${GREEN}Port 53 has been released.${RESET}"
    else
        echo -e "${GREEN}Port 53 is not occupied.${RESET}"
    fi
}

# Display script title
echo -e "${BLUE}======================================${RESET}"
echo -e "${GREEN}     One-click SmartDNS and Sniproxy Setup Script          ${RESET}"
echo -e "${CYAN}       Version:  $SCRIPT_VERSION                ${RESET}"
echo -e "${CYAN}       Last Updated: $LAST_UPDATED         ${RESET}"
echo -e "${CYAN}       SmartDNS config path: $SMART_CONFIG_FILE       ${RESET}"
echo -e "${CYAN}       Sniproxy config path: $SNIPROXY_CONFIG      ${RESET}"
echo -e "${CYAN}       Streaming list: $STREAM_CONFIG_FILE ${RESET}"
echo -e "${BLUE}======================================${RESET}"
echo -e "\n"

# View added platforms
view_added_platforms() {
    echo -e "${CYAN}Added platforms:${RESET}"
    grep -E '^#> ' "$SMART_CONFIG_FILE" | sed 's/^# //' | uniq || echo -e "${YELLOW}No platforms have been added yet.${RESET}"
}

# Check if platform is already added
is_platform_added() {
    local platform_name="$1"
    grep -q "^#> $platform_name" "$SMART_CONFIG_FILE"
}


# Add domain rules to configuration file
add_domain_rules() {
    local method="$1"  # nameserver or address
    local domains="$2" # domain list
    local identifier="$3" # group name or IP
    local platform_name="$4" # platform name

    # Add comment
    # Format: #> Netflix us
    echo "#> $platform_name ${identifier}" >>"$SMART_CONFIG_FILE"
    if [[ "$method" == "nameserver" ]]; then
        while IFS= read -r domain; do
            echo "nameserver /$domain/$identifier" >>"$SMART_CONFIG_FILE"
        done <<<"$domains"
    elif [[ "$method" == "address" ]]; then
        while IFS= read -r domain; do
            echo "address /$domain/$identifier" >>"$SMART_CONFIG_FILE"
        done <<<"$domains"
    fi
    echo -e "${GREEN}Successfully added domains for $platform_name using $method method, with comment added.${RESET}"
}

# Modify existing platform rules
modify_platform_rules() {
    local platform_name="$1"
    local domains="$2"

    echo -e "${CYAN}Please select a new add method:${RESET}"
    echo -e "${YELLOW}1. nameserver method${RESET}"
    echo -e "${YELLOW}2. address method${RESET}"
    read -r add_method

    case $add_method in
    1)
        view_upstream_dns_groups
        echo -e "${CYAN}Enter an existing DNS group name (e.g.: us):${RESET}"
        read -r group_name
        if ! grep -q " -group $group_name" "$SMART_CONFIG_FILE"; then
            echo -e "${RED}Specified DNS group does not exist! Please create the group first.${RESET}"
            return
        fi
        # Delete existing rules
        sed -i "/^#> $platform_name/,/^$/d" "$SMART_CONFIG_FILE"
        add_domain_rules "nameserver" "$domains" "$group_name" "$platform_name"
        ;;
    2)
        view_upstream_dns
        echo -e "${CYAN}Enter DNS server IP address (e.g.: 11.22.33.44):${RESET}"
        read -r dns_ip
        if [[ ! $dns_ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo -e "${RED}Invalid IP address, please try again!${RESET}"
            return
        fi
        # Delete existing rules
        sed -i "/^#> $platform_name/,/^$/d" "$SMART_CONFIG_FILE"
        add_domain_rules "address" "$domains" "$dns_ip" "$platform_name"
        ;;
    *)
        echo -e "${RED}Invalid choice, please enter again!${RESET}"
        ;;
    esac
}


# Service management function
manage_service() {
    local service=$1
    local action=$2
    local description=$3

    echo -e "${CYAN}${description} ${service} service...${RESET}"
    systemctl $action $service
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}${service} ${description} succeeded.${RESET}"
    else
        echo -e "${RED}${service} ${description} failed, please check system logs.${RESET}"
        return 1
    fi
}

# Check service status function
check_service_status() {
    local service=$1
    local service_name=$2

    local is_active=$(systemctl is-active "$service" 2>/dev/null)
    local is_enabled=$(systemctl is-enabled "$service" 2>/dev/null)

    echo -e "${CYAN}${service_name} service status:${RESET}$( [ "$is_active" == "active" ] && echo -e "${GREEN}running${RESET}" || echo -e "${RED}stopped${RESET}" )"
    echo -e "${CYAN}${service_name} auto-start on boot:${RESET}$( [ "$is_enabled" == "enabled" ] && echo -e "${GREEN}enabled${RESET}" || echo -e "${RED}disabled${RESET}" )"
}

# Restore service and enable auto-start on boot
restore_service() {
    local service=$1
    manage_service "$service" start "Start"
    manage_service "$service" enable "Enable auto-start on boot"
}

# Stop service and disable auto-start on boot
stop_service() {
    local service=$1
    manage_service "$service" stop "Stop"
    manage_service "$service" disable "Disable auto-start on boot"
}

# SmartDNS status check
check_smartdns_status() {
    check_service_status "smartdns" "SmartDNS"
}

# System DNS status check
check_system_dns_status() {
    check_service_status "systemd-resolved" "system DNS"
}

# Sniproxy status check
check_sniproxy_status() {
    check_service_status "sniproxy" "sniproxy"
}

# Restore system DNS service
restore_system_dns() {
    stop_service "smartdns"
    restore_service "systemd-resolved"
    echo -e "${GREEN}System DNS service has been started and enabled on boot.${RESET}"
}

# Restore Sniproxy service
restore_sniproxy() {
    restore_service "sniproxy"
    echo -e "${GREEN}Sniproxy service has been started and enabled on boot.${RESET}"
}

# Restore SmartDNS service
start_smartdns() {
    stop_service "systemd-resolved"
    restore_service "smartdns"
    motify_resolv "127.0.0.1"
    echo -e "${GREEN}SmartDNS service has been started and enabled on boot!${RESET}"
}

# Stop system DNS service
stop_system_dns() {
    stop_service "systemd-resolved"
    echo -e "${GREEN}System DNS service has been stopped and auto-start disabled.${RESET}"
}

# Stop SmartDNS service
stop_smartdns() {
    stop_service "smartdns"
    echo -e "${GREEN}SmartDNS service has been stopped and auto-start disabled.${RESET}"
}

# Stop Sniproxy service
stop_sniproxy() {
    stop_service "sniproxy"
    echo -e "${GREEN}Sniproxy service has been stopped and auto-start disabled.${RESET}"
}

# Modify /etc/resolv.conf file
motify_resolv() {
    local ip=$1
    echo "nameserver ${ip}" > /etc/resolv.conf 2>/dev/null
    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}/etc/resolv.conf has been successfully updated to nameserver ${ip}${RESET}"
    else
        echo -e "${RED}Failed to modify /etc/resolv.conf, please check file permissions.${RESET}"
    fi
}

# View streaming platform list
view_streaming_platforms() {

    check_files

    if [[ ! -f "$STREAM_CONFIG_FILE" ]]; then
        echo -e "${RED}[ERROR] StreamConfig.yaml file not found, please check path: $STREAM_CONFIG_FILE${RESET}"
        return
    fi

    echo -e "${CYAN}Streaming platform list:${RESET}"
    yq '. | keys' "$STREAM_CONFIG_FILE" | jq -r '.[]' | nl || echo -e "${YELLOW}No available streaming platform configuration.${RESET}"

    echo -e "${CYAN}Do you want to view secondary keys? (y/N): ${RESET}"
    read -r view_nested
    if [[ "$view_nested" =~ ^[Yy]$ ]]; then
        echo -e "${CYAN}Enter primary streaming platform index:${RESET}"
        read -r platform_index
        platform_name=$(yq '. | keys' "$STREAM_CONFIG_FILE" | jq -r ".[$((platform_index - 1))]")
        if [[ -z $platform_name ]]; then
            echo -e "${RED}Invalid index, please try again!${RESET}"
            return
        fi
        echo -e "${CYAN}Secondary key contents:${RESET}"
        yq ".$platform_name | keys" "$STREAM_CONFIG_FILE" | jq -r '.[]' | nl
    fi
}

# View secondary streaming platforms of a specified primary platform
view_nested_streaming_platforms() {
    local platform_name="$1"
    echo -e "${CYAN}Below is the list of secondary streaming platforms for $platform_name:${RESET}"
    yq ".$platform_name | keys" "$STREAM_CONFIG_FILE" | jq -r '.[]' | nl || echo -e "${YELLOW}This platform has no configured secondary streaming platforms.${RESET}"
}

# Download streaming list file
download_Stream_Config_File() {
    log_CYAN "Downloading streaming configuration file..."
    wget -q "$REMOTE_STREAM_CONFIG_FILE_URL" -O "$STREAM_CONFIG_FILE"
    if [[ $? -eq 0 ]]; then
        log_GREEN "Default streaming configuration file downloaded."
    else
        log_RED "Failed to download streaming configuration file, please check network connection."
        exit 1
    fi
}

# File Existence Check
check_files() {
    if [[ ! -f "$SMART_CONFIG_FILE" ]]; then
        log_RED "SmartDNS configuration file not found: $SMART_CONFIG_FILE"
        log_CYAN "Please make sure SmartDNS is installed."
        exit 1
    fi

    if [[ ! -f "$STREAM_CONFIG_FILE" ]]; then
        log_RED "Streaming configuration file not found: $STREAM_CONFIG_FILE"
        download_Stream_Config_File
    fi
}


# Add all streaming platforms
add_all_streaming_platforms() {
    if [[ ! -f "$STREAM_CONFIG_FILE" ]]; then
        echo -e "${RED}[Error] StreamConfig.yaml file not found, please check path: $STREAM_CONFIG_FILE${RESET}"
        return
    fi

    log_RED "Are you sure you want to add all streaming platforms? y/N"
    read -r confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo -e "${CYAN}Operation cancelled, returning to main menu.${RESET}"
        return
    fi

    echo -e "${CYAN}Please select the add method:${RESET}"
    echo -e "${YELLOW}1. nameserver method${RESET}"
    echo -e "${YELLOW}2. address method${RESET}"
    read -r add_method

    case $add_method in
    1)
        echo -e "${CYAN}Please enter an existing DNS group name (e.g., us):${RESET}"
        read -r group_name
        if ! grep -q " -group $group_name" "$SMART_CONFIG_FILE"; then
            echo -e "${RED}The specified DNS group does not exist! Please create the group first.${RESET}"
            return
        fi

        yq '.' "$STREAM_CONFIG_FILE" | jq -r 'paths | select(length == 2) | .[0] as $k1 | .[1] as $k2 | "\($k1) \($k2)"' | while read -r platform sub_platform; do
            domains=$(yq ".$platform.$sub_platform[]" "$STREAM_CONFIG_FILE" | tr -d '"')
            echo "#> $sub_platform" >>"$SMART_CONFIG_FILE"
            while IFS= read -r domain; do
                echo "nameserver /$domain/$group_name" >>"$SMART_CONFIG_FILE"
            done <<<"$domains"
        done
        echo -e "${GREEN}All streaming platform domains have been added using the nameserver method.${RESET}"
        ;;
    2)
        echo -e "${CYAN}Please enter the DNS server IP address (e.g., 11.22.33.44):${RESET}"
        read -r dns_ip
        if [[ ! $dns_ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo -e "${RED}Invalid IP address, please try again!${RESET}"
            return
        fi

        yq '.' "$STREAM_CONFIG_FILE" | jq -r 'paths | select(length == 2) | .[0] as $k1 | .[1] as $k2 | "\($k1) \($k2)"' | while read -r platform sub_platform; do
            domains=$(yq ".$platform.$sub_platform[]" "$STREAM_CONFIG_FILE" | tr -d '"')
            echo "#> $sub_platform" >>"$SMART_CONFIG_FILE"
            while IFS= read -r domain; do
                echo "address /$domain/$dns_ip" >>"$SMART_CONFIG_FILE"
            done <<<"$domains"
        done
        echo -e "${GREEN}All streaming platform domains have been added using the address method.${RESET}"
        ;;
    *)
        echo -e "${RED}Invalid choice, please try again!${RESET}"
        ;;
    esac
}

# Add streaming platforms for one region
add_one_region_streaming_platforms() {
    check_files

    while true; do
        echo -e "${BLUE}Do you want to add streaming platforms for one region? (y/N): ${RESET}"
        read -r add_one_region
        if [[ "$add_one_region" =~ ^[Yy]$ ]]; then
            echo -e "${CYAN}Please enter the index of the primary streaming platform:${RESET}"
            yq '. | keys' "$STREAM_CONFIG_FILE" | jq -r '.[]' | nl || echo -e "${YELLOW}No available streaming platform configuration.${RESET}"
            read -r platform_index

            platform_name=$(yq '. | keys' "$STREAM_CONFIG_FILE" | jq -r ".[$((platform_index - 1))]")
            if [[ -z $platform_name ]]; then
                echo -e "${RED}Invalid index, please try again!${RESET}"
                return
            fi

            echo -e "${CYAN}You selected the primary platform: ${GREEN}$platform_name${RESET}"

            # Check if secondary keys exist
            sub_platforms=$(yq ".$platform_name | keys" "$STREAM_CONFIG_FILE" | jq -r '.[]')
            if [[ -z $sub_platforms ]]; then
                echo -e "${YELLOW}No secondary streaming platforms configured for this group.${RESET}"
                return
            fi

            echo -e "${CYAN}Please select the add method:${RESET}"
            echo -e "${YELLOW}1. nameserver method${RESET}"
            echo -e "${YELLOW}2. address method${RESET}"
            read -r add_method

            case $add_method in
            1)
                view_upstream_dns_groups

                echo -e "${CYAN}Please enter an existing DNS group name (e.g., us):${RESET}"
                read -r group_name
                if ! grep -q " -group $group_name" "$SMART_CONFIG_FILE"; then
                    echo -e "${RED}The specified DNS group does not exist! Please create the group first.${RESET}"
                    return
                fi

                for nested_name in $sub_platforms; do
                    domains=$(yq ".$platform_name.$nested_name[]" "$STREAM_CONFIG_FILE" | tr -d '"')
                    if [[ -z $domains ]]; then
                        echo -e "${YELLOW}Skipping secondary platform with no domain configuration: $nested_name${RESET}"
                        continue
                    fi
                    echo -e "${CYAN}Adding domain rules for $nested_name...${RESET}"
                    add_domain_rules "nameserver" "$domains" "$group_name" "$nested_name"
                done
                echo -e "${GREEN}Nameserver method added for all secondary streaming platforms under $platform_name.${RESET}"
                ;;
            2)
                echo -e "${CYAN}Please enter the DNS server IP address (e.g., 11.22.33.44):${RESET}"
                read -r dns_ip
                if [[ ! $dns_ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                    echo -e "${RED}Invalid IP address, please try again!${RESET}"
                    return
                fi

                for nested_name in $sub_platforms; do
                    domains=$(yq ".$platform_name.$nested_name[]" "$STREAM_CONFIG_FILE" | tr -d '"')
                    if [[ -z $domains ]]; then
                        echo -e "${YELLOW}Skipping secondary platform with no domain configuration: $nested_name${RESET}"
                        continue
                    fi
                    echo -e "${CYAN}Adding domain rules for $nested_name...${RESET}"
                    add_domain_rules "address" "$domains" "$dns_ip" "$nested_name"
                done
                echo -e "${GREEN}Address method added for all secondary streaming platforms under $platform_name.${RESET}"
                ;;
            *)
                echo -e "${RED}Invalid choice, please try again!${RESET}"
                ;;
            esac
        else
            break
        fi
    done
}

# Add a streaming platform to SmartDNS
add_streaming_platform() {
    check_files
    while true; do
        echo -e "${BLUE}Do you want to add a streaming platform? (y/N): ${RESET}"
        read -r add_dns
        if [[ "$add_dns" =~ ^[Yy]$ ]]; then
            echo -e "${CYAN}Please enter the index of the primary streaming platform:${RESET}"
            yq '. | keys' "$STREAM_CONFIG_FILE" | jq -r '.[]' | nl || echo -e "${YELLOW}No available streaming platform configuration.${RESET}"
            read -r platform_index

            platform_name=$(yq '. | keys' "$STREAM_CONFIG_FILE" | jq -r ".[$((platform_index - 1))]")
            if [[ -z $platform_name ]]; then
                echo -e "${RED}Invalid index, please try again!${RESET}"
                return
            fi

            echo -e "${CYAN}You selected the primary platform: ${GREEN}$platform_name${RESET}"

            echo -e "${CYAN}Please enter the index of the secondary streaming platform:${RESET}"
            view_nested_streaming_platforms "$platform_name"
            read -r nested_index

            nested_name=$(yq ".$platform_name | keys" "$STREAM_CONFIG_FILE" | jq -r ".[$((nested_index - 1))]")
            if [[ -z $nested_name ]]; then
                echo -e "${RED}Invalid index, please try again!${RESET}"
                return
            fi

            echo -e "${CYAN}You selected the secondary platform: ${GREEN}$nested_name${RESET}"
            domains=$(yq ".$platform_name.$nested_name[]" "$STREAM_CONFIG_FILE" | tr -d '"')

            if [[ -z $domains ]]; then
                echo -e "${YELLOW}No domain configuration found for this streaming platform.${RESET}"
                return
            fi

            if is_platform_added "$nested_name"; then
                echo -e "${YELLOW}This platform already exists. Do you want to modify its configuration? (y/N)${RESET}"
                read -r modify_choice
                if [[ "$modify_choice" =~ ^[Yy]$ ]]; then
                    modify_platform_rules "$nested_name" "$domains"
                else
                    echo -e "${CYAN}Operation cancelled.${RESET}"
                fi
            else
                echo -e "${CYAN}Please select an add method:${RESET}"
                echo -e "${YELLOW}1. nameserver method${RESET}"
                echo -e "${YELLOW}2. address method${RESET}"
                read -r add_method

                case $add_method in
                1)
                    view_upstream_dns_groups

                    echo -e "${CYAN}Please enter an existing DNS group name (e.g., us):${RESET}"
                    read -r group_name
                    if ! grep -q " -group $group_name" "$SMART_CONFIG_FILE"; then
                        echo -e "${RED}The specified DNS group does not exist! Please create the group first.${RESET}"
                        return
                    fi
                    add_domain_rules "nameserver" "$domains" "$group_name" "$nested_name"
                    ;;
                2)
                    view_upstream_dns

                    echo -e "${CYAN}Please enter the DNS server IP address (e.g., 11.22.33.44):${RESET}"
                    read -r dns_ip
                    if [[ ! $dns_ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                        echo -e "${RED}Invalid IP address, please try again!${RESET}"
                        return
                    fi
                    add_domain_rules "address" "$domains" "$dns_ip" "$nested_name"
                    ;;
                *)
                    echo -e "${RED}Invalid choice, please try again!${RESET}"
                    ;;
                esac
            fi
        else
            break
        fi
    done
}

# Add domain rules to the table block in /etc/sniproxy.conf
add_domain_to_sniproxy_table() {
    local domain="$1"

    # Check if the configuration file exists
    if [[ ! -f "$SNIPROXY_CONFIG" ]]; then
        echo -e "${RED}[Error] sniproxy configuration file not found: $SNIPROXY_CONFIG${RESET}"
        return 1
    fi

    # Check if the table block exists
    local table_start=$(grep -n "^table {" "$SNIPROXY_CONFIG" | cut -d: -f1)

    if [[ -z $table_start  ]]; then
        echo -e "${RED}[Error] table block not found in sniproxy configuration file!${RESET}"
        return 1
    fi

    # Check if the domain already exists
    if grep -q ".*${domain//./\\.} *" "$SNIPROXY_CONFIG"; then
        echo -e "${YELLOW}Skipping existing domain: $domain${RESET}"
        return
    fi

    # Insert domain after the last entry in the table block
    sed -i "${table_start}a \    .*${domain//./\\.} *" "$SNIPROXY_CONFIG"
    echo -e "${GREEN}Domain added to table block: $domain${RESET}"
}

# Add domain rules to sniproxy
add_streaming_to_sniproxy() {
    local platform_name="$1"
    local sub_platform_name="$2"

    # If a secondary streaming platform is provided
    if [[ -n "$sub_platform_name" ]]; then
        echo -e "${CYAN}Processing platform: $platform_name -> $sub_platform_name${RESET}"
        local domains=$(yq ".$platform_name.$sub_platform_name[]" "$STREAM_CONFIG_FILE" 2>/dev/null | tr -d '"')
        if [[ -z $domains ]]; then
            echo -e "${YELLOW}No domain configuration found for $platform_name -> $sub_platform_name, skipping...${RESET}"
            return
        fi

        # Iterate through domains and add them to the table block
        for domain in $domains; do
            add_domain_to_sniproxy_table "$domain"
        done

    # If only the primary streaming platform is provided
    elif [[ -n "$platform_name" ]]; then
        echo -e "${CYAN}Processing primary platform: $platform_name${RESET}"
        local sub_platforms=$(yq ".$platform_name | keys" "$STREAM_CONFIG_FILE" 2>/dev/null | jq -r '.[]')
        if [[ -z $sub_platforms ]]; then
            echo -e "${YELLOW}No secondary platform configuration found for $platform_name, skipping...${RESET}"
            return
        fi

        # Recursively process each secondary platform
        for sub_platform in $sub_platforms; do
            add_streaming_to_sniproxy "$platform_name" "$sub_platform"
        done
    else
        echo -e "${RED}Error: No valid platform name specified!${RESET}"
        return 1
    fi
}

# User selects to add streaming domains to sniproxy
add_streaming_domains_to_sniproxy() {
    
    check_files

    echo -e "${CYAN}Please choose an action:${RESET}"
    echo -e "${YELLOW}1.${RESET} Add a single streaming platform"
    echo -e "${YELLOW}2.${RESET} Add all streaming platforms within a region"
    read -r choice

    case $choice in
    1)
        echo -e "${CYAN}Please enter the index of the primary streaming platform:${RESET}"
        yq '. | keys' "$STREAM_CONFIG_FILE" | jq -r '.[]' | nl
        read -r platform_index

        local platform_name=$(yq '. | keys' "$STREAM_CONFIG_FILE" | jq -r ".[$((platform_index - 1))]")
        if [[ -z $platform_name ]]; then
            echo -e "${RED}Invalid index, please try again!${RESET}"
            return
        fi

        echo -e "${CYAN}You selected the primary platform: ${GREEN}$platform_name${RESET}"
        echo -e "${CYAN}Please enter the index of the secondary streaming platform:${RESET}"
        yq ".$platform_name | keys" "$STREAM_CONFIG_FILE" | jq -r '.[]' | nl
        read -r sub_platform_index

        local sub_platform_name=$(yq ".$platform_name | keys" "$STREAM_CONFIG_FILE" | jq -r ".[$((sub_platform_index - 1))]")
        if [[ -z $sub_platform_name ]]; then
            echo -e "${RED}Invalid index, please try again!${RESET}"
            return
        fi

        add_streaming_to_sniproxy "$platform_name" "$sub_platform_name"
        ;;
    2)
        echo -e "${CYAN}Please enter the index of the primary streaming platform:${RESET}"
        yq '. | keys' "$STREAM_CONFIG_FILE" | jq -r '.[]' | nl
        read -r platform_index

        local platform_name=$(yq '. | keys' "$STREAM_CONFIG_FILE" | jq -r ".[$((platform_index - 1))]")
        if [[ -z $platform_name ]]; then
            echo -e "${RED}Invalid index, please try again!${RESET}"
            return
        fi

        add_streaming_to_sniproxy "$platform_name"
        ;;
    *)
        echo -e "${RED}Invalid choice, please try again!${RESET}"
        ;;
    esac
}

# Check if ufw is installed and enable it
check_and_enable_ufw() {
    if ! command -v ufw &>/dev/null; then
        log_YELLOW "UFW firewall not detected. Do you want to install UFW? (y/N):"
        read -r install_ufw
        if [[ "$install_ufw" =~ ^[Yy]$ ]]; then
            sudo apt-get update
            sudo apt-get install -y ufw
            log_YELLOW "Make sure SSH port 22 is open, otherwise remote access may fail! Opening port 22..."
            sudo ufw allow 22
            log_GREEN "Port 22 opened successfully."
        else
            log_RED "UFW is not installed, cannot continue."
            exit 1
        fi
    fi

    if ! sudo ufw status | grep -q "active"; then
        log_YELLOW "UFW is not active. Do you want to enable UFW? (y/N):"
        read -r start_ufw
        if [[ "$start_ufw" =~ ^[Yy]$ ]]; then
            sudo ufw enable
            log_GREEN "UFW started successfully!"
            log_YELLOW "Make sure SSH port 22 is open, otherwise remote access may fail! Opening port 22..."
            sudo ufw allow 22
            log_GREEN "Port 22 opened successfully."
        else
            log_RED "UFW is not active, cannot continue."
            exit 1
        fi
    fi
}

# Open ports 80/443/53 for a specified IP
unlock_ports() {
    log_CYAN "Please enter the IP address of the unlocked machine:"
    read -r unlocked_ip

    # Verify if the IP format is correct
    if [[ ! "$unlocked_ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        log_RED "Invalid IP address format!"
        return
    fi
    # Open ports 80/443/53
    sudo ufw allow from "$unlocked_ip" to any port 80 proto tcp
    sudo ufw allow from "$unlocked_ip" to any port 80 proto udp
    sudo ufw allow from "$unlocked_ip" to any port 443 proto tcp
    sudo ufw allow from "$unlocked_ip" to any port 443 proto udp
    sudo ufw allow from "$unlocked_ip" to any port 53 proto udp

    log_GREEN "Successfully opened the following ports for $unlocked_ip: 80, 443, 53 (tcp & udp)"
}

# One-click open a custom port
open_custom_port() {
    log_CYAN "Please enter the port number to open:"
    read -r custom_port

    # Verify if the port number is valid
    if [[ ! "$custom_port" =~ ^[0-9]+$ ]] || ((custom_port < 1 || custom_port > 65535)); then
        log_RED "Invalid port number! Please enter a number between 1-65535."
        return
    fi

    sudo ufw allow "$custom_port"/tcp
    sudo ufw allow "$custom_port"/udp
    log_GREEN "Successfully opened port $custom_port (TCP and UDP)."
    log_GREEN "The ufw command to open ports is as follows:"
    log_YELLOW "sudo ufw allow from xx.xx.xx.xx to any port 53 proto udp"
}

# Function to change global DNS
set_global_dns() {
    echo -e "${CYAN}Changing global DNS to 8.8.8.8...${RESET}"

    # Check if /etc/resolv.conf is writable
    if [[ -w /etc/resolv.conf ]]; then
        # Backup the original resolv.conf
        cp /etc/resolv.conf /etc/resolv.conf.bak
        rm /etc/resolv.conf
        echo "nameserver 8.8.8.8" > /etc/resolv.conf

        # Verify if writing was successful
        if grep -q "8.8.8.8" /etc/resolv.conf; then
            echo -e "${GREEN}Global DNS successfully changed to 8.8.8.8${RESET}"
        else
            echo -e "${RED}Change failed, please check /etc/resolv.conf permissions.${RESET}"
        fi
    else
        echo -e "${RED}/etc/resolv.conf is not writable, please check permissions or manually change DNS.${RESET}"
    fi
}

# Main menu
while true; do
    echo -e "${GREEN}-----------Please select an operation to execute-----------${RESET}"
    echo -e "${YELLOW}-----------Unlocked Machine--------------${RESET}"
    echo -e "${CYAN}1.${RESET} ${GREEN} Install SmartDNS${RESET}"
    echo -e "${CYAN}2.${RESET} ${GREEN} Reconfigure SmartDNS${RESET}"
    echo -e "${CYAN}3.${RESET} ${GREEN} Add upstream DNS and group${RESET}"
    echo -e "${CYAN}4.${RESET} ${GREEN} View configured upstream DNS groups${RESET}"
    echo -e "${CYAN}5.${RESET} ${GREEN} View streaming platform list${RESET}"
    echo -e "${CYAN}6.${RESET} ${GREEN} Add a streaming platform to SmartDNS${RESET}"
    echo -e "${CYAN}7.${RESET} ${GREEN} Add a regional streaming platform to SmartDNS${RESET}"
    echo -e "${CYAN}8.${RESET} ${GREEN} Add all streaming platforms to SmartDNS${RESET}"
    echo -e "${CYAN}9.${RESET} ${GREEN} View already added streaming platforms${RESET}"
    echo -e "${YELLOW}-----------sniproxy Related (Unlocked Machine)--------------${RESET}"
    echo -e "${CYAN}11.${RESET} ${GREEN} Install and start sniproxy${RESET}"
    echo -e "${CYAN}12.${RESET} ${GREEN} Add streaming platform to sniproxy${RESET}"
    echo -e "${CYAN}13.${RESET} ${GREEN} Start/Restart sniproxy service and enable on boot${RESET}"
    echo -e "${CYAN}14.${RESET} ${GREEN} Stop sniproxy and disable on boot${RESET}"
    echo -e "${CYAN}15.${RESET} ${GREEN} One-click open ports 80/443/53 for unlocked machine${RESET}"
    echo -e "${CYAN}16.${RESET} ${GREEN} One-click open specified firewall (ufw) ports${RESET}"
    echo -e "${YELLOW}-----------SmartDNS Related (Unlocked Machine)--------------${RESET}"
    echo -e "${CYAN}21.${RESET} ${GREEN} Start/Restart SmartDNS service and enable on boot${RESET}"
    echo -e "${CYAN}22.${RESET} ${GREEN} Stop SmartDNS and disable on boot${RESET}"
    echo -e "${CYAN}23.${RESET} ${GREEN} Start/Restart system DNS and enable on boot${RESET}"
    echo -e "${CYAN}24.${RESET} ${GREEN} Stop system DNS and disable on boot${RESET}"
    echo -e "${YELLOW}-----------DNS Emergency--------------${RESET}"
    echo -e "${CYAN}31.${RESET} ${GREEN} Change global DNS to 8.8.8.8${RESET}"
    echo -e "${YELLOW}-----------Script Related--------------${RESET}"
    echo -e "${CYAN}t.${RESET} ${GREEN} Streaming platform check${RESET}"
    echo -e "${CYAN}u.${RESET} ${GREEN} Check script updates${RESET}"
    echo -e "${CYAN}d.${RESET} ${GREEN} Download latest streaming platform list file${RESET}"
    echo -e "${CYAN}q.${RESET} ${RED} Exit script${RESET}"
    echo -e "${YELLOW}---Service status (SmartDNS and system DNS do not run simultaneously)---${RESET}"

    check_smartdns_status
    check_system_dns_status
    check_sniproxy_status

    echo -e "\n${YELLOW}Please choose:${RESET}"
    read -r choice

    case $choice in
    1)
        check_smartdns_installed || install_smartdns
        ;;
    2)
        configure_smartdns
        restore_system_dns
        start_smartdns
        ;;
    3)
        add_upstream_dns_group
        restore_system_dns
        start_smartdns
        ;;
    4)
        view_upstream_dns_groups
        ;;
    5)
        view_streaming_platforms
        ;;
    6)
        add_streaming_platform
        restore_system_dns
        start_smartdns
        ;;
    7)
        add_one_region_streaming_platforms
        restore_system_dns
        start_smartdns
        ;;
    8)
        add_all_streaming_platforms
        restore_system_dns
        start_smartdns
        ;;
    9)
        view_added_platforms
        ;;
    11)
        install_sniproxy
        ;;
    12)
        add_streaming_domains_to_sniproxy
        systemctl restart sniproxy
        ;;
    13)
        restore_sniproxy
        ;;
    14)
        stop_sniproxy
        ;;
    15)
        check_and_enable_ufw
        unlock_ports
        ;;
    16)
        check_and_enable_ufw
        open_custom_port
        ;;
    21)
        start_smartdns
        ;;
    22)
        stop_smartdns
        ;;
    23)
        restore_system_dns
        ;;
    24)
        stop_system_dns
        ;;
    31)
        set_global_dns
        ;;
    t)
        bash <(curl -L -s $REMOTE_RegionRestrictionCheck_URL)
        ;;
    u)
        check_script_update
        ;;
    d)
        rm StreamConfig.yaml
        download_Stream_Config_File
        ;;
    q)
        echo -e "${RED}Exiting script...${RESET}"
        exit 0
        ;;
    *)
        echo -e "${RED}Invalid choice, please enter again!${RESET}"
        ;;
    esac
done
